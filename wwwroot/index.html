<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Správa filmů a seriálů</title>
    <style>
        /* --- MODERNÍ CSS STYLY --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        :root {
            --primary-color: #007BFF;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --light-bg: #f8f9fa;
            --dark-bg: #e9ecef;
            --border-color: #dee2e6;
            --box-shadow: 0 0.5rem 1rem rgba(0,0,0,.05);
            --border-radius: 0.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            background-color: #f4f7f9;
            color: #343a40;
            margin: 0;
            padding: 2rem;
        }
        
        main {
            max-width: 1200px;
            margin: auto;
            background: #ffffff;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-top: 0;
            margin-bottom: 1.5rem;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 2rem;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        tr:last-child td {
            border-bottom: none;
        }

        tr:nth-child(even) {
            background-color: var(--light-bg);
        }
        
        td img {
            max-width: 80px;
            height: auto;
            border-radius: var(--border-radius);
        }
        
        td.actions {
            white-space: nowrap;
            text-align: right;
        }
        
        .form-container, .search-container {
            margin-bottom: 2rem;
        }
        
        input[type="text"], input[type="search"], select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            margin-bottom: 1rem;
            box-sizing: border-box;
        }

        button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            transform: translateY(-1px);
        }
        
        button.primary { background-color: var(--primary-color); }
        button.primary:hover { background-color: #0056b3; }
        
        button.secondary { background-color: var(--secondary-color); }
        button.secondary:hover { background-color: #5a6268; }
        
        button.edit { background-color: var(--warning-color); }
        button.edit:hover { background-color: #e0a800; }
        
        button.delete { background-color: var(--danger-color); }
        button.delete:hover { background-color: #c82333; }
        
        button.save { background-color: var(--success-color); }
        button.save:hover { background-color: #218838; }

        #episode-manager { display: none; }
        
        .season-block {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
        }
        
        .episode-item {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .episode-item:last-child { border-bottom: none; }

        .episode-item span {
            flex-grow: 1;
            margin-right: 1rem;
        }
        
        #toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--success-color);
            color: white;
            padding: 1rem 2rem;
            border-radius: var(--border-radius);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            z-index: 1000;
        }
        
        #toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-1rem);
        }
        
        #toast.error { background-color: var(--danger-color); }
        
        .autocomplete-container { position: relative; }
        
        .autocomplete-items {
            position: absolute;
            border: 1px solid var(--border-color);
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: var(--box-shadow);
            border-radius: 0 0 var(--border-radius) var(--border-radius);
        }
        
        .autocomplete-items div {
            padding: 0.75rem;
            cursor: pointer;
            background-color: #fff;
            border-bottom: 1px solid var(--border-color);
        }
        
        .autocomplete-items div:hover { background-color: var(--dark-bg); }
        
        .suggestion-info {
            font-size: 0.8rem;
            color: var(--secondary-color);
            margin-left: 0.5rem;
        }
        
        .links-container {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--light-bg);
        }
        
        .link-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .link-row:last-child { margin-bottom: 0; }
        
        .link-row input[type="text"] {
            flex-grow: 1;
            min-width: 200px;
            margin-bottom: 0;
        }
        
        .link-row select {
            flex-grow: 0.5;
            min-width: 100px;
            margin-bottom: 0;
        }
        
        .link-row button {
            flex-shrink: 0;
            margin-left: 0;
        }
        
        .form-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .form-buttons button { margin-left: 0; }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
            transition: opacity 0.3s;
            opacity: 0;
            pointer-events: none;
        }
        .loading-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .spinner {
            border: 4px solid var(--dark-bg);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
    </div>
    
    <main>
        <div id="main-view">
            <h1>Správa filmů a seriálů</h1>
            <div class="search-container">
                <h2>Vyhledat v mé databázi</h2>
                <input type="search" id="search-box" placeholder="Začni psát název...">
            </div>
            <div class="form-container">
                <h2 id="form-title">Přidat položku</h2>
                <form id="add-item-form">
                    <input type="hidden" id="itemId">
                    
                    <div class="autocomplete-container">
                        <input type="text" id="title" placeholder="Název filmu nebo seriálu pro vyhledání na TMDb" required autocomplete="off">
                        <div id="autocomplete-list" class="autocomplete-items"></div>
                    </div>

                    <div id="links-container" class="links-container">
                        <div class="link-row">
                            <input type="text" class="fileIdent-input" placeholder="ID z Webshare (např. vsgrvEEWju)" oninput="handleUrlInput(this)">
                            <select class="quality-select">
                                <option value="1080p">1080p</option>
                                <option value="720p">720p</option>
                                <option value="480p">480p</option>
                            </select>
                            <button type="button" class="delete-link-button" style="display:none;">Smazat</button>
                        </div>
                    </div>
                    <button type="button" class="primary add-link-button">Přidat další odkaz</button>
                    
                    <div class="form-buttons">
                        <button type="submit" class="primary" id="submit-button">Přidat film</button>
                        <button type="button" class="primary" id="add-show-button">Přidat seriál</button>
                        <button type="button" class="secondary" id="cancel-button" style="display:none;">Zrušit úpravu</button>
                    </div>
                </form>
            </div>
            <h2>Seznam v databázi</h2>
            <table id="items-table">
                <thead><tr><th>Plakát</th><th>Název</th><th>Typ</th><th style="text-align: right;">Akce</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="episode-manager">
            <h2 id="show-title-header"></h2>
            <div id="seasons-container"></div>
            <button class="secondary" onclick="closeEpisodeManager()" style="margin-top: 20px;">Zpět na hlavní seznam</button>
        </div>
    </main>
    <div id="toast"></div>

    <script>
        const mainView = document.getElementById('main-view');
        const episodeManager = document.getElementById('episode-manager');
        const itemsTableBody = document.querySelector('#items-table tbody');
        const searchBox = document.getElementById('search-box');
        const addItemForm = document.getElementById('add-item-form');
        const itemIdInput = document.getElementById('itemId');
        const titleInput = document.getElementById('title');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const addShowButton = document.getElementById('add-show-button');
        const cancelButton = document.getElementById('cancel-button');
        const toast = document.getElementById('toast');
        const linksContainer = document.getElementById('links-container');
        const addLinkButton = document.querySelector('.add-link-button');
        const loadingOverlay = document.getElementById('loading-overlay');

        const apiMoviesUrl = '/api/Movies';
        const apiShowsUrl = '/api/Shows';
        const apiEpisodesUrl = '/api/Episodes';
        const apiSearchUrl = '/api/Search';
        const apiTMDbUrl = '/api/TMDb';

        // Funkce pro zobrazení/skrytí načítání
        function showLoading() { loadingOverlay.classList.add('visible'); }
        function hideLoading() { loadingOverlay.classList.remove('visible'); }

        const autocompleteList = document.getElementById('autocomplete-list');
        let debounceTimer;

        function handleUrlInput(inputElement) {
            clearTimeout(inputElement.dataset.debounce);
            inputElement.dataset.debounce = setTimeout(() => {
                const url = inputElement.value;
                const match = url.match(/\/file\/([a-zA-Z0-9]+)/);
                const fileIdent = match && match[1] ? match[1] : url;

                inputElement.value = fileIdent;

                const qualitySelect = inputElement.closest('.link-row').querySelector('.quality-select');
                const lowerUrl = url.toLowerCase();
                
                if (lowerUrl.includes('1080p') || lowerUrl.includes('fhd')) {
                    qualitySelect.value = '1080p';
                } else if (lowerUrl.includes('720p') || lowerUrl.includes('hd')) {
                    qualitySelect.value = '720p';
                } else if (lowerUrl.includes('480p') || lowerUrl.includes('sd')) {
                    qualitySelect.value = '480p';
                } else {
                    qualitySelect.value = '1080p'; // Defaultní hodnota
                }
            }, 300);
        }
        
        function handleUrlInputForEpisode(inputElement, episodeId) {
            handleUrlInput(inputElement);
            if (inputElement.value.trim().length > 10) {
                saveEpisodeLinks(episodeId);
            }
        }

        titleInput.addEventListener('input', function(e) {
            clearTimeout(debounceTimer);
            const query = this.value;
            if (!query || query.length < 2) {
                closeAllLists();
                return false;
            }
            debounceTimer = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });

        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`${apiTMDbUrl}/search?query=${encodeURIComponent(query)}`);
                if (!response.ok) return;
                const suggestions = await response.json();
                closeAllLists();
                suggestions.forEach(item => {
                    const div = document.createElement("DIV");
                    div.innerHTML = `<strong>${item.title}</strong><span class="suggestion-info">${item.type} (${item.year})</span>`;
                    div.addEventListener("click", function(e) {
                        titleInput.value = item.title;
                        closeAllLists();
                    });
                    autocompleteList.appendChild(div);
                });
            } catch (error) {
                console.error('Chyba při načítání návrhů:', error);
            }
        }

        function closeAllLists() { autocompleteList.innerHTML = ''; }
        document.addEventListener("click", function (e) {
            if (e.target !== titleInput) { closeAllLists(); }
        });

        function showToast(message, isError = false) { 
            toast.textContent = message; 
            toast.className = 'show' + (isError ? ' error' : ''); 
            setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000); 
        }

        function displayResults(items) {
            itemsTableBody.innerHTML = '';
            if (!items || items.length === 0) { itemsTableBody.innerHTML = `<tr><td colspan="4">Nebyly nalezeny žádné položky.</td></tr>`; return; }
            items.forEach(item => {
                const row = itemsTableBody.insertRow();
                const type = item.hasOwnProperty('links') ? 'Film' : 'Seriál';
                row.insertCell().innerHTML = item.posterPath ? `<img src="https://image.tmdb.org/t/p/w92${item.posterPath}" alt="Plakát">` : '';
                row.insertCell().textContent = item.title;
                row.insertCell().textContent = type;
                const actionsCell = row.insertCell();
                actionsCell.className = 'actions';
                if (type === 'Film') {
                     const linksJson = JSON.stringify(item.links);
                     actionsCell.innerHTML = `<button class="edit" onclick='editMovie(${item.id}, "${item.title.replace(/"/g, '&quot;')}", ${linksJson})'>Upravit ID</button> <button class="delete" onclick="deleteItem(${item.id}, true)">Smazat</button>`;
                } else {
                    actionsCell.innerHTML = `<button class="primary" onclick="manageShow(${item.id})">Spravovat epizody</button> <button class="delete" onclick="deleteItem(${item.id}, false)">Smazat</button>`;
                }
            });
        }
        
        async function fetchAllItems() {
            showLoading();
            try {
                const [moviesRes, showsRes] = await Promise.all([
                    fetch(apiMoviesUrl), 
                    fetch(apiShowsUrl)
                ]);
                const movies = await moviesRes.json();
                const shows = await showsRes.json();
                const allItems = [...movies, ...shows].sort((a, b) => (a.title || '').localeCompare(b.title || ''));
                displayResults(allItems);
            } catch (error) { 
                console.error('Chyba při načítání:', error); 
                showToast('Chyba při načítání dat z databáze.', true);
            } finally {
                hideLoading();
            }
        }

        async function search(query) {
            if (!query || query.trim() === '') { fetchAllItems(); return; }
            showLoading();
            try {
                const response = await fetch(`${apiSearchUrl}?query=${encodeURIComponent(query)}`);
                const results = await response.json();
                displayResults(results);
            } catch (error) { 
                console.error('Chyba při vyhledávání:', error); 
                showToast('Chyba při vyhledávání dat.', true);
            } finally {
                hideLoading();
            }
        }
        searchBox.addEventListener('input', () => search(searchBox.value));

        function addLinkRow(fileIdent = '', quality = '1080p', container = linksContainer, deleteAllowed = true) {
            const row = document.createElement('div');
            row.className = 'link-row';
            row.innerHTML = `
                <input type="text" class="fileIdent-input" placeholder="ID z Webshare (např. vsgrvEEWju)" value="${fileIdent}" oninput="handleUrlInput(this)">
                <select class="quality-select">
                    <option value="1080p" ${quality === '1080p' ? 'selected' : ''}>1080p</option>
                    <option value="720p" ${quality === '720p' ? 'selected' : ''}>720p</option>
                    <option value="480p" ${quality === '480p' ? 'selected' : ''}>480p</option>
                </select>
                <button type="button" class="delete-link-button">Smazat</button>
            `;
            if (!deleteAllowed) {
                row.querySelector('.delete-link-button').style.display = 'none';
            }
            container.appendChild(row);

            row.querySelector('.delete-link-button').addEventListener('click', () => {
                if (container.querySelectorAll('.link-row').length > 1) {
                    row.remove();
                } else {
                    showToast('Musí být alespoň jeden odkaz.', true);
                }
            });
        }
        addLinkButton.addEventListener('click', () => addLinkRow());

        function cancelEdit() {
            itemIdInput.value = '';
            titleInput.value = '';
            titleInput.disabled = false;
            submitButton.textContent = 'Přidat film';
            addShowButton.style.display = 'inline-block';
            formTitle.textContent = 'Přidat položku';
            cancelButton.style.display = 'none';
            linksContainer.innerHTML = '';
            addLinkRow();
        }
        cancelButton.addEventListener('click', cancelEdit);

        function editMovie(id, title, links) {
            itemIdInput.value = id;
            titleInput.value = title;
            titleInput.disabled = true;
            submitButton.textContent = 'Uložit změny ID';
            addShowButton.style.display = 'none';
            formTitle.textContent = `Upravit ID pro: ${title}`;
            cancelButton.style.display = 'block';
            linksContainer.innerHTML = '';
            if (links && links.length > 0) {
                links.forEach(link => addLinkRow(link.fileIdent, link.quality));
            } else {
                addLinkRow();
            }
            window.scrollTo(0, 0);
        }

        addItemForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            showLoading();
            const id = itemIdInput.value;
            const isUpdating = !!id;
            const links = Array.from(linksContainer.querySelectorAll('.link-row')).map(row => {
                const fileIdent = row.querySelector('.fileIdent-input').value.trim();
                const quality = row.querySelector('.quality-select').value;
                return { fileIdent, quality };
            }).filter(link => link.fileIdent);

            if (links.length === 0) {
                showToast('Musí být alespoň jeden odkaz!', true);
                hideLoading();
                return;
            }

            const url = isUpdating ? `${apiMoviesUrl}/${id}` : apiMoviesUrl;
            const method = isUpdating ? 'PUT' : 'POST';
            const body = isUpdating
                ? { links: links }
                : { title: titleInput.value, links: links };

            try {
                const response = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!response.ok) throw new Error('Chyba serveru');
                showToast(isUpdating ? 'Odkazy filmu úspěšně upraveny!' : 'Film úspěšně přidán!');
                cancelEdit();
                search(searchBox.value || '');
            } catch (error) { 
                showToast('Chyba při ukládání filmu.', true); 
                console.error(error);
            } finally {
                hideLoading();
            }
        });

        addShowButton.addEventListener('click', async () => {
            showLoading();
            const showData = { title: titleInput.value };
            try {
                const response = await fetch(apiShowsUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(showData) });
                if (!response.ok) throw new Error('Chyba serveru');
                showToast('Seriál úspěšně přidán!');
                addItemForm.reset();
                search(searchBox.value || '');
            } catch (error) { 
                showToast('Chyba při přidávání seriálu.', true); 
                console.error(error);
            } finally {
                hideLoading();
            }
        });

        async function deleteItem(id, isMovie) {
            const url = isMovie ? `${apiMoviesUrl}/${id}` : `${apiShowsUrl}/${id}`;
            const itemType = isMovie ? 'Film' : 'Seriál';
            if (confirm(`Opravdu smazat: ${itemType.toLowerCase()}?`)) {
                showLoading();
                try {
                    await fetch(url, { method: 'DELETE' });
                    showToast(`${itemType} smazán.`, false);
                    fetchAllItems();
                } catch (error) {
                    showToast(`Chyba při mazání ${itemType.toLowerCase()}.`, true);
                    console.error(error);
                } finally {
                    hideLoading();
                }
            }
        }

        function closeEpisodeManager() {
            episodeManager.style.display = 'none';
            mainView.style.display = 'block';
            fetchAllItems();
        }

        async function manageShow(showId) {
            showLoading();
            try {
                const response = await fetch(`${apiShowsUrl}/${showId}`);
                if (!response.ok) throw new Error('Seriál nenalezen');
                const show = await response.json();
                document.getElementById('show-title-header').textContent = `Epizody pro: ${show.title}`;
                const seasonsContainer = document.getElementById('seasons-container');
                seasonsContainer.innerHTML = '';

                show.seasons.sort((a,b) => a.seasonNumber - b.seasonNumber).forEach(season => {
                    if (season.seasonNumber === 0) return;
                    const seasonBlock = document.createElement('div');
                    seasonBlock.className = 'season-block';
                    seasonBlock.innerHTML = `<h3>Série ${season.seasonNumber}</h3>`;
                    
                    season.episodes.sort((a,b) => a.episodeNumber - b.episodeNumber).forEach(episode => {
                        const episodeItem = document.createElement('div');
                        episodeItem.className = 'episode-item';
                        episodeItem.innerHTML = `<span>E${String(episode.episodeNumber).padStart(2, '0')}: ${episode.title}</span>`;
                        
                        const linksSubContainer = document.createElement('div');
                        linksSubContainer.className = 'links-container';
                        
                        if (episode.links && episode.links.length > 0) {
                             episode.links.forEach(link => addLinkRowForEpisode(episode.id, link.fileIdent, link.quality));
                        } else {
                            addLinkRowForEpisode(episode.id);
                        }
                        
                        episodeItem.appendChild(linksSubContainer);
                        
                        seasonBlock.appendChild(episodeItem);
                    });
                    seasonsContainer.appendChild(seasonBlock);
                });
                mainView.style.display = 'none';
                episodeManager.style.display = 'block';
            } catch (error) { 
                showToast('Nepodařilo se načíst detaily seriálu.', true);
                console.error(error);
            } finally {
                hideLoading();
            }
        }

        function addLinkRowForEpisode(episodeId, fileIdent = '', quality = '1080p') {
            const linksContainer = document.createElement('div');
            linksContainer.className = 'links-container';
            
            const row = document.createElement('div');
            row.className = 'link-row';
            row.innerHTML = `
                <input type="text" class="fileIdent-input" placeholder="ID z Webshare" value="${fileIdent}" oninput="handleUrlInputForEpisode(this, ${episodeId})">
                <select class="quality-select">
                    <option value="1080p" ${quality === '1080p' ? 'selected' : ''}>1080p</option>
                    <option value="720p" ${quality === '720p' ? 'selected' : ''}>720p</option>
                    <option value="480p" ${quality === '480p' ? 'selected' : ''}>480p</option>
                </select>
                <button type="button" class="delete-link-button">Smazat</button>
                <button class="save" onclick="saveEpisodeLinks(${episodeId})">Uložit</button>
            `;
            
            row.querySelector('.delete-link-button').addEventListener('click', () => {
                if (row.parentNode.querySelectorAll('.link-row').length > 1) {
                    row.remove();
                } else {
                    showToast('Musí být alespoň jeden odkaz.', true);
                }
            });
            
            linksContainer.appendChild(row);
            const parentElement = document.querySelector(`#seasons-container .episode-item:has(span:contains("E${String(episodeId)}"))`);
            if (parentElement) {
                parentElement.appendChild(linksContainer);
            }
        }


        async function saveEpisodeLinks(episodeId) {
            const episodeItem = document.querySelector(`#seasons-container .episode-item:has(span:contains("E${String(episodeId)}"))`);
            const linksContainer = episodeItem.querySelector('.links-container');

            const links = Array.from(linksContainer.querySelectorAll('.link-row')).map(row => {
                const fileIdent = row.querySelector('.fileIdent-input').value.trim();
                const quality = row.querySelector('.quality-select').value;
                return { fileIdent, quality };
            }).filter(link => link.fileIdent);

            if (links.length === 0) {
                showToast('Musí být alespoň jeden odkaz!', true);
                return;
            }

            showLoading();
            try {
                const response = await fetch(`${apiEpisodesUrl}/${episodeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ links: links })
                });
                if (!response.ok) throw new Error('Chyba při ukládání');
                showToast('Odkazy epizody uloženy!');
                linksContainer.style.backgroundColor = '#d4edda';
                setTimeout(() => { linksContainer.style.backgroundColor = ''; }, 1500);
            } catch(error) {
                linksContainer.style.backgroundColor = '#f8d7da';
                showToast('Chyba při ukládání odkazů.', true);
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAllItems);
    </script>
</body>
</html>